#!/bin/bash
##----------------------------------------------------##
# runs nek cases every 7300 seconds.
#
# INPUT: $1: case name
#        $2: base folder name
#        $3: # of last completed case
##----------------------------------------------------##

case=$1
base=$2
num=$3

email="vpuri3@illinois.edu" # email log after queuing
res="restart0.f00001"       # name of restart file
rsfx="0.f00002"             # suffix of next restart file
bsfx="0.f00001"             # suffix for budgets file

dir=$PWD
log=$dir/run.log

echo "##############################################" |& tee -a $log
echo "##############################################" |& tee -a $log
echo "##############################################" |& tee -a $log
echo $(date -R)                                       |& tee -a $log
echo "Starting new session in directory $dir."        |& tee -a $log
echo "Running case $case starting from $base$num"     |& tee -a $log
echo "Storing log in $log"

for i in {1..10}
do
    dir0=$dir/$base$num
    num=$((num+1))
    dir1=$dir/$base$num

    echo "#--------------------------------------------#"  |& tee -a $log
    echo "#------------- ITERATION $i ------------------#" |& tee -a $log
    echo "#--------------------------------------------#"  |& tee -a $log
    echo $(date -R)                                        |& tee -a $log

    echo "copying $dir0 to $dir1" |& tee -a $log
    cp -ir $dir0 $dir1            |& tee -a $log

    cd  $dir1

    echo "removing old logs and switching restart" |& tee -a $log
    rm *.cobaltlog *.error *.output                |& tee -a $log
    rm $res *log*                                  |& tee -a $log
    mv $case$rsfx $res                             |& tee -a $log

    echo "restarting from $res"               |& tee -a $log
    head -c 130 $res                          |& tee -a $log
    echo -e '\n'                              |& tee -a $log
    echo "reading budgets from i**$case$bsfx" |& tee -a $log
    head -c 130 i01$case$bsfx                 |& tee -a $log
    echo -e '\n'                              |& tee -a $log
    # exit if either of these files are not found.

    echo "compiling and running" |& tee -a $log
    makenek $case                |& tee -a $log # exit if compilation unseccessful.
    ./my_nekqsub $case 256       |& tee -a $log
 
    cd $dir

    echo "successfully queued job. See you in two hrs."
    echo "goodnight" |& tee -a $log

    mail -s "$1 autorun" $email < $log

    sleep 7200
    echo $(date -R)                            |& tee -a $log
    echo "2 hrs done. starting next iteration" |& tee -a $log

    sleep 100
done